<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0D0D0D">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Kisan Guru">
<meta name="description" content="India's Farm-to-Market Intelligence Platform">
<title>Kisan Market Guru</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@700;800&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
<style>
/* ============================================================
   KISAN MARKET GURU ‚Äî TERMINAL EDITION
   Aesthetic: Dark luxury trading terminal √ó Indian textile motifs
   Colors: Deep obsidian + Saffron gold + Emerald signal
   ============================================================ */

:root {
  --gold:       #F5A623;
  --gold-dim:   #C27F0E;
  --gold-glow:  rgba(245,166,35,0.18);
  --emerald:    #00D084;
  --emerald-dim:#00965E;
  --emerald-glow: rgba(0,208,132,0.15);
  --red:        #FF4D4D;
  --red-dim:    #CC1A1A;
  --red-glow:   rgba(255,77,77,0.15);
  --blue:       #4DA6FF;
  --blue-glow:  rgba(77,166,255,0.12);

  --bg:         #0A0A0A;
  --bg2:        #111111;
  --bg3:        #181818;
  --surface:    rgba(255,255,255,0.04);
  --surface2:   rgba(255,255,255,0.07);
  --border:     rgba(255,255,255,0.08);
  --border-gold:rgba(245,166,35,0.3);
  --text:       #F0EAD6;
  --text-dim:   #8A8070;
  --text-muted: #5A5248;

  --font-display: 'Syne', 'Noto Sans Devanagari', sans-serif;
  --font-mono:    'Space Mono', 'Courier New', monospace;
  --font-body:    'Noto Sans Devanagari', Georgia, serif;

  --nav-h: 68px;
  --header-h: 60px;
}

/* ---- RESET ---- */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  height: 100%;
  overflow-x: hidden;
  /* Subtle grain texture overlay */
  position: relative;
}

/* Grain overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9998;
  opacity: 0.6;
}

/* ============================================================
   GEOMETRIC BACKGROUND PATTERN ‚Äî Indian diamond motif
   ============================================================ */
.geo-bg {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;
}
.geo-bg::before {
  content: '';
  position: absolute;
  inset: 0;
  background-image:
    repeating-linear-gradient(45deg, rgba(245,166,35,0.025) 0px, transparent 1px, transparent 30px, rgba(245,166,35,0.025) 31px),
    repeating-linear-gradient(-45deg, rgba(245,166,35,0.025) 0px, transparent 1px, transparent 30px, rgba(245,166,35,0.025) 31px);
}
.geo-bg::after {
  content: '';
  position: absolute;
  top: -200px; right: -200px;
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(245,166,35,0.06) 0%, transparent 65%);
  pointer-events: none;
}

/* ============================================================
   APP SHELL
   ============================================================ */
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 430px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* ============================================================
   HEADER
   ============================================================ */
#header {
  height: var(--header-h);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 18px;
  flex-shrink: 0;
  border-bottom: 1px solid var(--border);
  background: rgba(10,10,10,0.9);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  position: relative;
  z-index: 50;
}

/* Gold top accent line */
#header::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), var(--emerald), transparent);
}

.hdr-brand {
  display: flex;
  align-items: center;
  gap: 10px;
}

.hdr-icon {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  box-shadow: 0 0 16px var(--gold-glow);
  flex-shrink: 0;
}

.hdr-text { line-height: 1; }
.hdr-title {
  font-family: var(--font-display);
  font-size: 15px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.3px;
}
.hdr-sub {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--gold);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-top: 2px;
}

.hdr-right {
  display: flex;
  gap: 6px;
  align-items: center;
}

.hdr-pill {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 8px;
  padding: 7px 11px;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
  letter-spacing: 0.5px;
  -webkit-tap-highlight-color: transparent;
}
.hdr-pill:active { background: var(--gold-glow); border-color: var(--border-gold); color: var(--gold); }
.hdr-pill.glow { border-color: var(--border-gold); color: var(--gold); }

/* ============================================================
   MAIN CONTENT AREA
   ============================================================ */
#content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(var(--nav-h) + 8px);
  scroll-behavior: smooth;
}

.tab-pane { display: none; }
.tab-pane.active { display: block; animation: fadeUp 0.25s ease; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ============================================================
   BOTTOM NAVIGATION ‚Äî Terminal style
   ============================================================ */
#bottom-nav {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 430px;
  height: var(--nav-h);
  display: flex;
  background: rgba(12,12,12,0.96);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  z-index: 100;
}

.nav-tab {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  border: none;
  background: none;
  cursor: pointer;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  transition: color 0.2s;
  -webkit-tap-highlight-color: transparent;
  position: relative;
}
.nav-tab::after {
  content: '';
  position: absolute;
  bottom: 0; left: 25%; right: 25%;
  height: 2px;
  background: var(--gold);
  border-radius: 2px 2px 0 0;
  transform: scaleX(0);
  transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1);
}
.nav-tab.active { color: var(--gold); }
.nav-tab.active::after { transform: scaleX(1); }

.nav-icon-wrap {
  width: 36px; height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  font-size: 17px;
  transition: background 0.2s;
}
.nav-tab.active .nav-icon-wrap { background: var(--gold-glow); }

.nav-live-pip {
  position: absolute;
  top: 8px;
  right: calc(50% - 18px);
  width: 6px; height: 6px;
  background: var(--red);
  border-radius: 50%;
  animation: blink 1.4s infinite;
}
@keyframes blink {
  0%,100% { opacity: 1; }
  50% { opacity: 0.2; }
}

/* ============================================================
   GLASSMORPHISM PANEL
   ============================================================ */
.panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  position: relative;
  transition: border-color 0.2s;
}
.panel.gold-border { border-color: var(--border-gold); }
.panel.emerald-border { border-color: rgba(0,208,132,0.25); }

.panel-head {
  padding: 14px 18px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.panel-title {
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 800;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-dim);
  display: flex;
  align-items: center;
  gap: 8px;
}
.panel-title .dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}
.dot-gold { background: var(--gold); box-shadow: 0 0 6px var(--gold); }
.dot-green { background: var(--emerald); box-shadow: 0 0 6px var(--emerald); }
.dot-red { background: var(--red); box-shadow: 0 0 6px var(--red); }

/* ============================================================
   ‚ñà‚ñà TAB 1 ‚Äî FARM INTELLIGENCE
   ============================================================ */
#tab-home { padding: 16px; display: flex; flex-direction: column; gap: 14px; }

/* Input selector grid */
.selector-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.selector-grid .full { grid-column: 1 / -1; }

.sel-label {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 6px;
  display: block;
}

.sel-wrap { position: relative; }
.sel-wrap::after {
  content: '‚ñæ';
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gold);
  font-size: 12px;
  pointer-events: none;
}

select.field, input.field {
  width: 100%;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: 14px;
  padding: 13px 36px 13px 14px;
  appearance: none;
  -webkit-appearance: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  outline: none;
}
select.field:focus, input.field:focus {
  border-color: var(--border-gold);
  box-shadow: 0 0 0 3px var(--gold-glow);
}
input.field { padding-right: 14px; }
input.field::placeholder { color: var(--text-muted); }

.gps-row { display: flex; gap: 8px; align-items: flex-end; }
.gps-row .sel-group { flex: 1; }

/* Analyze button */
.analyze-btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, var(--gold) 0%, #E8891A 100%);
  border: none;
  border-radius: 14px;
  color: #0A0A0A;
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 800;
  letter-spacing: 0.5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: 0 4px 24px rgba(245,166,35,0.35);
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
  position: relative;
  overflow: hidden;
}
.analyze-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.15) 50%, transparent 100%);
  transform: translateX(-100%);
  transition: transform 0.6s;
}
.analyze-btn:active::before { transform: translateX(100%); }
.analyze-btn:active { transform: scale(0.98); box-shadow: 0 2px 12px rgba(245,166,35,0.2); }
.btn-icon { font-size: 20px; }

/* GPS button */
.gps-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 10px;
  padding: 13px 14px;
  font-size: 16px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}
.gps-btn:active { border-color: var(--border-gold); color: var(--gold); }

/* ---- RESULTS ---- */
#resultsSection { display: flex; flex-direction: column; gap: 14px; margin-top: 0; }

/* Harvest score ‚Äî big horizontal layout */
.harvest-hero {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 18px;
  align-items: center;
  padding: 18px;
}

.score-ring-wrap { position: relative; flex-shrink: 0; }
.score-ring-svg { width: 100px; height: 100px; transform: rotate(-90deg); }
.ring-bg { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 8; }
.ring-fill {
  fill: none;
  stroke: var(--gold);
  stroke-width: 8;
  stroke-linecap: round;
  stroke-dasharray: 251;
  stroke-dashoffset: 251;
  transition: stroke-dashoffset 1.2s cubic-bezier(0.34,1.56,0.64,1);
  filter: drop-shadow(0 0 6px var(--gold));
}
.ring-fill.emerald { stroke: var(--emerald); filter: drop-shadow(0 0 6px var(--emerald)); }
.ring-fill.red-ring { stroke: var(--red); filter: drop-shadow(0 0 6px var(--red)); }
.score-center {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.score-number {
  font-family: var(--font-mono);
  font-size: 26px;
  font-weight: 700;
  color: var(--gold);
  line-height: 1;
}
.score-label {
  font-family: var(--font-mono);
  font-size: 8px;
  color: var(--text-muted);
  letter-spacing: 1px;
  text-transform: uppercase;
}

.harvest-meta { display: flex; flex-direction: column; gap: 6px; }
.harvest-days-big {
  font-family: var(--font-display);
  font-size: 38px;
  font-weight: 800;
  color: var(--gold);
  line-height: 1;
}
.harvest-days-unit { font-size: 15px; color: var(--text-dim); font-weight: 400; margin-left: 4px; }
.harvest-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 100px;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.5px;
  width: fit-content;
}
.status-go { background: rgba(0,208,132,0.15); color: var(--emerald); border: 1px solid rgba(0,208,132,0.3); }
.status-wait { background: rgba(245,166,35,0.12); color: var(--gold); border: 1px solid var(--border-gold); }
.status-hold { background: rgba(255,77,77,0.12); color: var(--red); border: 1px solid rgba(255,77,77,0.3); }

/* Factor bars */
.factor-bars { padding: 0 18px 16px; display: flex; flex-direction: column; gap: 8px; }
.factor-row { display: flex; align-items: center; gap: 10px; }
.factor-name { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); width: 70px; flex-shrink: 0; letter-spacing: 0.5px; }
.factor-track { flex: 1; height: 5px; background: rgba(255,255,255,0.06); border-radius: 100px; overflow: hidden; }
.factor-fill { height: 100%; border-radius: 100px; transition: width 1s ease; }
.fill-gold { background: linear-gradient(90deg, var(--gold-dim), var(--gold)); }
.fill-green { background: linear-gradient(90deg, var(--emerald-dim), var(--emerald)); }
.fill-blue { background: linear-gradient(90deg, #2A7FCC, var(--blue)); }
.factor-val { font-family: var(--font-mono); font-size: 11px; color: var(--text); width: 30px; text-align: right; }

/* Why reasoning block */
.reason-block {
  margin: 0 18px 16px;
  background: rgba(245,166,35,0.06);
  border: 1px solid rgba(245,166,35,0.15);
  border-left: 3px solid var(--gold);
  border-radius: 0 10px 10px 0;
  padding: 12px 14px;
}
.reason-tag {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 5px;
}
.reason-text { font-size: 13px; color: var(--text-dim); line-height: 1.55; }

/* Markets table */
.markets-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.mkt-table { width: 100%; border-collapse: collapse; min-width: 340px; }
.mkt-table th {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
  padding: 10px 14px;
  text-align: left;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.mkt-table td { padding: 13px 14px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
.mkt-table tr:last-child td { border-bottom: none; }
.mkt-table tr.top-row td { background: rgba(245,166,35,0.04); }
.mkt-table tr:hover td { background: var(--surface2); }

.rank-num {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 700;
  width: 26px; height: 26px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.rn1 { background: rgba(245,166,35,0.2); color: var(--gold); }
.rn2 { background: rgba(180,180,180,0.15); color: #B0B0B0; }
.rn3 { background: rgba(180,100,30,0.15); color: #C08040; }
.rn-x { background: var(--surface2); color: var(--text-muted); }

.mandi-name { font-size: 13px; font-weight: 700; color: var(--text); display: block; }
.mandi-state { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); }
.price-mono { font-family: var(--font-mono); font-size: 14px; font-weight: 700; color: var(--gold); }
.dist-mono { font-family: var(--font-mono); font-size: 12px; color: var(--text-dim); }
.trend-up { color: var(--emerald); font-size: 13px; font-weight: 700; }
.trend-dn { color: var(--red); font-size: 13px; font-weight: 700; }

/* Spoilage */
.spoilage-layout {
  padding: 18px;
  display: flex;
  gap: 20px;
  align-items: flex-start;
}
.risk-big {
  flex-shrink: 0;
  text-align: center;
  width: 80px;
}
.risk-pct {
  font-family: var(--font-mono);
  font-size: 42px;
  font-weight: 700;
  line-height: 1;
}
.risk-low { color: var(--emerald); text-shadow: 0 0 20px var(--emerald-dim); }
.risk-med { color: var(--gold); text-shadow: 0 0 20px var(--gold-dim); }
.risk-high { color: var(--red); text-shadow: 0 0 20px var(--red-dim); }
.risk-word { font-family: var(--font-mono); font-size: 10px; letter-spacing: 1px; color: var(--text-muted); margin-top: 2px; text-transform: uppercase; }

.risk-factors { flex: 1; display: flex; flex-direction: column; gap: 10px; }
.rf-item { }
.rf-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.rf-name { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); letter-spacing: 0.5px; text-transform: uppercase; }
.rf-val { font-family: var(--font-mono); font-size: 11px; color: var(--text); font-weight: 700; }
.rf-track { height: 4px; background: rgba(255,255,255,0.06); border-radius: 100px; overflow: hidden; }
.rf-fill { height: 100%; border-radius: 100px; }

/* Preservation table */
.pres-list { display: flex; flex-direction: column; gap: 0; }
.pres-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 13px 18px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transition: background 0.2s;
}
.pres-item:last-child { border-bottom: none; }
.pres-item:hover { background: var(--surface2); }
.pres-rank-box {
  width: 32px; height: 32px;
  border-radius: 8px;
  background: var(--surface2);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}
.pres-info { flex: 1; min-width: 0; }
.pres-action { font-size: 13px; font-weight: 700; color: var(--text); }
.pres-why { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pres-cost { font-family: var(--font-mono); font-size: 12px; color: var(--text-dim); flex-shrink: 0; }
.eff-bar-wrap { width: 40px; }
.eff-arc { font-family: var(--font-mono); font-size: 11px; font-weight: 700; text-align: right; }
.eff-high { color: var(--emerald); }
.eff-mid  { color: var(--gold); }
.eff-low  { color: var(--red); }

/* Voice btn */
.voice-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-muted);
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
  display: flex;
  align-items: center;
  gap: 5px;
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 0.5px;
}
.voice-btn:active { border-color: var(--blue); color: var(--blue); }

/* ============================================================
   ‚ñà‚ñà TAB 2 ‚Äî LIVE PRICES
   ============================================================ */
#tab-live { padding: 0 0 8px; }

/* Top scrolling ticker */
.ticker-strip {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 10px 0;
  overflow: hidden;
  position: sticky;
  top: 0;
  z-index: 10;
}
.ticker-track {
  display: flex;
  white-space: nowrap;
  animation: scrollTicker 50s linear infinite;
  width: max-content;
}
.ticker-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 0 16px;
  font-family: var(--font-mono);
  font-size: 12px;
  border-right: 1px solid var(--border);
}
.tc-name { color: var(--text-dim); }
.tc-price { color: var(--text); font-weight: 700; }
.tc-up { color: var(--emerald); }
.tc-dn { color: var(--red); }
@keyframes scrollTicker {
  0%   { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

/* Status bar */
.live-statusbar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
}
.live-pip { width: 7px; height: 7px; background: var(--red); border-radius: 50%; animation: blink 1.4s infinite; flex-shrink: 0; }
.live-label { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); letter-spacing: 0.5px; flex: 1; }
.cdbar { flex: 1; max-width: 80px; height: 3px; background: var(--border); border-radius: 100px; overflow: hidden; }
.cdbar-fill { height: 100%; background: var(--emerald); border-radius: 100px; transition: width 1s linear; }
.cd-num { font-family: var(--font-mono); font-size: 11px; color: var(--emerald); width: 28px; text-align: right; }

/* Filter row */
.filter-strip { display: flex; gap: 8px; padding: 10px 16px; }
.filter-strip select.field { padding: 9px 32px 9px 12px; font-size: 12px; border-radius: 8px; }
.export-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 8px;
  padding: 9px 12px;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.5px;
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.2s;
}
.export-btn:active { border-color: var(--border-gold); color: var(--gold); }

/* Prices list */
.live-list { padding: 0 16px; display: flex; flex-direction: column; gap: 0; }

/* Column headers */
.live-col-head {
  display: grid;
  grid-template-columns: 1fr 90px 70px 90px;
  gap: 0;
  padding: 8px 14px;
  margin-bottom: 4px;
}
.live-col-head span {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
  cursor: pointer;
}
.live-col-head span:not(:first-child) { text-align: right; }

.price-row {
  display: grid;
  grid-template-columns: 1fr 90px 70px 90px;
  gap: 0;
  align-items: center;
  padding: 11px 14px;
  border-radius: 10px;
  transition: background 0.15s;
  margin-bottom: 2px;
  cursor: default;
}
.price-row:hover { background: var(--surface2); }
.price-row.flash-up { animation: flashUp 0.5s ease; }
.price-row.flash-dn { animation: flashDn 0.5s ease; }
@keyframes flashUp { 0%,100% { background: transparent; } 30% { background: rgba(0,208,132,0.08); } }
@keyframes flashDn { 0%,100% { background: transparent; } 30% { background: rgba(255,77,77,0.08); } }

.pr-name { font-size: 13px; font-weight: 700; color: var(--text); }
.pr-local { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); }
.pr-price { font-family: var(--font-mono); font-size: 14px; font-weight: 700; color: var(--gold); text-align: right; }
.pr-chg { font-family: var(--font-mono); font-size: 12px; font-weight: 700; text-align: right; }
.pr-up { color: var(--emerald); }
.pr-dn { color: var(--red); }
.pr-hl {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  text-align: right;
  line-height: 1.4;
}

/* ============================================================
   ‚ñà‚ñà TAB 3 ‚Äî TRENDS
   ============================================================ */
#tab-trends { padding: 16px; display: flex; flex-direction: column; gap: 14px; }

.trend-selectors {
  display: flex;
  gap: 10px;
}
.trend-selectors .sel-group { flex: 1; }

.range-row { display: flex; gap: 6px; flex-wrap: wrap; }
.range-chip {
  padding: 8px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  letter-spacing: 0.5px;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.range-chip.active {
  background: var(--gold-glow);
  border-color: var(--border-gold);
  color: var(--gold);
  box-shadow: 0 0 12px var(--gold-glow);
}

/* Date pair */
.date-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.chart-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
}
.chart-canvas-wrap { position: relative; height: 230px; margin: 8px 0 4px; }
.chart-watermark {
  position: absolute;
  bottom: 8px; right: 8px;
  font-family: var(--font-mono);
  font-size: 9px;
  color: rgba(245,166,35,0.15);
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* Stats row */
.stats-trio {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 12px;
  text-align: center;
}
.stat-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
.stat-val { font-family: var(--font-mono); font-size: 18px; font-weight: 700; line-height: 1; }
.sv-min { color: var(--red); }
.sv-avg { color: var(--blue); }
.sv-max { color: var(--emerald); }

.insight-box {
  background: var(--surface);
  border: 1px solid var(--border-gold);
  border-radius: 12px;
  padding: 14px 16px;
  font-size: 13px;
  color: var(--text-dim);
  line-height: 1.55;
  position: relative;
}
.insight-box::before {
  content: '‚óà';
  color: var(--gold);
  margin-right: 8px;
  font-size: 14px;
}

/* ============================================================
   ‚ñà‚ñà TAB 4 ‚Äî WEATHER
   ============================================================ */
#tab-weather { padding: 16px; display: flex; flex-direction: column; gap: 14px; }

/* Today's big card */
.today-weather {
  background: linear-gradient(135deg, rgba(245,166,35,0.08) 0%, rgba(0,208,132,0.05) 100%);
  border: 1px solid var(--border-gold);
  border-radius: 18px;
  padding: 22px 20px;
  display: flex;
  align-items: center;
  gap: 20px;
}
.today-icon { font-size: 64px; line-height: 1; filter: drop-shadow(0 4px 16px rgba(245,166,35,0.3)); }
.today-info { flex: 1; }
.today-loc { font-family: var(--font-mono); font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--gold); margin-bottom: 4px; }
.today-cond { font-family: var(--font-display); font-size: 20px; font-weight: 800; color: var(--text); margin-bottom: 6px; }
.today-temp { font-family: var(--font-mono); font-size: 36px; font-weight: 700; color: var(--text); line-height: 1; }
.today-sub { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); margin-top: 4px; }

/* 7-day scroll */
.forecast-scroll {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 4px;
  scrollbar-width: none;
}
.forecast-scroll::-webkit-scrollbar { display: none; }

.fc-day {
  flex-shrink: 0;
  width: 80px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 8px;
  text-align: center;
  transition: border-color 0.2s;
}
.fc-day.fc-today { border-color: var(--border-gold); background: rgba(245,166,35,0.06); }
.fc-dayname { font-family: var(--font-mono); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
.fc-icon { font-size: 26px; margin-bottom: 6px; }
.fc-temp { font-family: var(--font-mono); font-size: 12px; color: var(--text); font-weight: 700; }
.fc-rain { font-family: var(--font-mono); font-size: 10px; color: var(--blue); margin-top: 3px; }
.fc-humid { font-family: var(--font-mono); font-size: 9px; color: var(--text-muted); margin-top: 2px; }

/* Tips */
.tips-list { display: flex; flex-direction: column; gap: 8px; }
.tip-item {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 13px 14px;
}
.tip-day-badge {
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  color: var(--gold);
  background: var(--gold-glow);
  border: 1px solid var(--border-gold);
  border-radius: 6px;
  padding: 4px 8px;
  white-space: nowrap;
  flex-shrink: 0;
  margin-top: 1px;
}
.tip-text { font-size: 13px; color: var(--text-dim); line-height: 1.5; }
.tip-icon { font-size: 15px; margin-right: 6px; }

/* ============================================================
   SHARED UTILITY
   ============================================================ */
.mt-0 { margin-top: 0 !important; }
.sel-group { display: flex; flex-direction: column; }

/* Loading state */
.load-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 50px 20px;
  gap: 14px;
}
.load-spinner {
  width: 38px; height: 38px;
  border: 3px solid var(--border);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.load-txt { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); letter-spacing: 1px; }

/* Empty state */
.empty-box {
  text-align: center;
  padding: 40px 20px;
}
.empty-glyph { font-size: 44px; margin-bottom: 12px; }
.empty-h { font-family: var(--font-display); font-size: 16px; font-weight: 800; color: var(--text-dim); margin-bottom: 6px; }
.empty-p { font-size: 13px; color: var(--text-muted); }

/* Toast */
#toast {
  position: fixed;
  bottom: calc(var(--nav-h) + 12px);
  left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: rgba(25,25,25,0.95);
  border: 1px solid var(--border-gold);
  color: var(--text);
  padding: 11px 18px;
  border-radius: 100px;
  font-family: var(--font-mono);
  font-size: 12px;
  letter-spacing: 0.3px;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: all 0.25s;
  max-width: 300px;
  text-align: center;
  backdrop-filter: blur(20px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  white-space: nowrap;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Confetti */
.cpiece {
  position: fixed;
  pointer-events: none;
  z-index: 9997;
  border-radius: 2px;
  animation: cfall linear forwards;
}
@keyframes cfall {
  0%   { transform: translateY(-10px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(110vh) rotate(540deg); opacity: 0; }
}

/* Scrollbar */
#content::-webkit-scrollbar { width: 3px; }
#content::-webkit-scrollbar-track { background: transparent; }
#content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 100px; }

/* Devanagari fallback */
@supports not (font-family: 'Syne') {
  .hdr-title, .panel-title, .harvest-days-big { font-weight: 900; }
}
</style>
</head>
<body>
<div class="geo-bg"></div>
<div id="app">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <header id="header">
    <div class="hdr-brand">
      <div class="hdr-icon">üåæ</div>
      <div class="hdr-text">
        <div class="hdr-title" id="hdrTitle">KISAN GURU</div>
        <div class="hdr-sub" id="hdrSub">MARKET INTELLIGENCE</div>
      </div>
    </div>
    <div class="hdr-right">
      <button class="hdr-pill glow" onclick="cycleLang()" id="langBtn">
        <span id="langFlag">üá¨üáß</span><span id="langCode">EN</span>
      </button>
      <button class="hdr-pill" onclick="toggleTheme()" id="themeBtn">‚òÄ</button>
    </div>
  </header>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="content">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 1: HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-pane active" id="tab-home">

      <!-- Input Panel -->
      <div style="padding:16px 16px 0">
        <div class="panel gold-border" style="margin-bottom:14px">
          <div class="panel-head">
            <div class="panel-title"><span class="dot dot-gold"></span><span id="t-inputTitle">CROP SELECTOR</span></div>
          </div>
          <div style="padding:16px;display:flex;flex-direction:column;gap:12px">
            <div class="sel-group">
              <span class="sel-label" id="t-selectCrop">Crop</span>
              <div class="sel-wrap">
                <select class="field" id="cropSelect"></select>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:flex-end">
              <div class="sel-group">
                <span class="sel-label" id="t-selectState">State</span>
                <div class="sel-wrap">
                  <select class="field" id="stateSelect"></select>
                </div>
              </div>
              <button class="gps-btn" onclick="useGPS()" title="Use GPS">üìç</button>
            </div>
            <div class="sel-group">
              <span class="sel-label" id="t-selectDistrict">District</span>
              <div class="sel-wrap">
                <select class="field" id="districtSelect"></select>
              </div>
            </div>
            <div class="sel-group">
              <span class="sel-label" id="t-farmSize">Farm Size (Acres) ‚Äî Optional</span>
              <input type="number" class="field" id="farmSizeInput" placeholder="e.g. 5" min="0.5" max="500" step="0.5">
            </div>
          </div>
        </div>

        <button class="analyze-btn" onclick="analyzeNow()" id="analyzeBtn">
          <span class="btn-icon">‚ö°</span>
          <span id="t-analyzeBtn">ANALYZE FIELD</span>
        </button>
      </div>

      <!-- Results -->
      <div id="resultsSection" style="display:none;padding:14px 16px 0;display:none;flex-direction:column;gap:14px">

        <!-- Harvest Window -->
        <div class="panel" id="harvestCard">
          <div class="panel-head">
            <div class="panel-title"><span class="dot dot-gold"></span><span id="t-harvestWindow">HARVEST WINDOW</span></div>
            <button class="voice-btn" onclick="speakSection('harvestText')">‚ñ∂ <span id="t-voicePlay">PLAY</span></button>
          </div>
          <div class="harvest-hero">
            <div class="score-ring-wrap">
              <svg class="score-ring-svg" viewBox="0 0 100 100">
                <circle class="ring-bg" cx="50" cy="50" r="40"/>
                <circle class="ring-fill" id="ringFill" cx="50" cy="50" r="40"/>
              </svg>
              <div class="score-center">
                <div class="score-number" id="harvestScore">‚Äî</div>
                <div class="score-label">SCORE</div>
              </div>
            </div>
            <div class="harvest-meta">
              <div>
                <span class="harvest-days-big" id="harvestDays">‚Äî</span>
                <span class="harvest-days-unit" id="t-harvestDays">days</span>
              </div>
              <div class="harvest-status status-wait" id="harvestStatus">ANALYZING‚Ä¶</div>
            </div>
          </div>
          <div class="factor-bars">
            <div class="factor-row">
              <span class="factor-name">WEATHER</span>
              <div class="factor-track"><div class="factor-fill fill-gold" id="fWeather" style="width:0%"></div></div>
              <span class="factor-val" id="fWeatherV">‚Äî</span>
            </div>
            <div class="factor-row">
              <span class="factor-name">SOIL</span>
              <div class="factor-track"><div class="factor-fill fill-green" id="fSoil" style="width:0%"></div></div>
              <span class="factor-val" id="fSoilV">‚Äî</span>
            </div>
            <div class="factor-row">
              <span class="factor-name">PRICE</span>
              <div class="factor-track"><div class="factor-fill fill-blue" id="fPrice" style="width:0%"></div></div>
              <span class="factor-val" id="fPriceV">‚Äî</span>
            </div>
          </div>
          <div class="reason-block" id="harvestReason">
            <div class="reason-tag" id="t-why">ANALYSIS</div>
            <div class="reason-text" id="harvestWhy">Run analysis to see AI insights.</div>
          </div>
          <p id="harvestText" style="display:none"></p>
        </div>

        <!-- Best Markets -->
        <div class="panel" id="marketsCard">
          <div class="panel-head">
            <div class="panel-title"><span class="dot dot-green"></span><span id="t-bestMarkets">BEST MARKETS</span></div>
            <button class="voice-btn" onclick="speakSection('marketsText')">‚ñ∂</button>
          </div>
          <div class="markets-wrap">
            <table class="mkt-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>MANDI</th>
                  <th>‚Çπ/QTL</th>
                  <th>KM</th>
                  <th>SIGNAL</th>
                </tr>
              </thead>
              <tbody id="marketsBody"></tbody>
            </table>
          </div>
          <p id="marketsText" style="display:none"></p>
        </div>

        <!-- Spoilage -->
        <div class="panel" id="spoilageCard">
          <div class="panel-head">
            <div class="panel-title"><span class="dot dot-red"></span><span id="t-spoilageRisk">SPOILAGE RISK</span></div>
            <button class="voice-btn" onclick="speakSection('spoilageText')">‚ñ∂</button>
          </div>
          <div class="spoilage-layout">
            <div class="risk-big">
              <div class="risk-pct" id="riskPct">‚Äî%</div>
              <div class="risk-word" id="riskWord">RISK</div>
            </div>
            <div class="risk-factors">
              <div class="rf-item">
                <div class="rf-row"><span class="rf-name">HUMIDITY</span><span class="rf-val" id="rfHumid">‚Äî</span></div>
                <div class="rf-track"><div class="rf-fill fill-gold" id="rfHumidBar" style="width:0%"></div></div>
              </div>
              <div class="rf-item">
                <div class="rf-row"><span class="rf-name">TEMP</span><span class="rf-val" id="rfTemp">‚Äî</span></div>
                <div class="rf-track"><div class="rf-fill fill-gold" id="rfTempBar" style="width:0%"></div></div>
              </div>
              <div class="rf-item">
                <div class="rf-row"><span class="rf-name">TRANSIT</span><span class="rf-val" id="rfTransit">‚Äî</span></div>
                <div class="rf-track"><div class="rf-fill" id="rfTransitBar" style="width:0%;background:var(--red)"></div></div>
              </div>
            </div>
          </div>
          <div class="reason-block" id="spoilageReason" style="margin-top:0">
            <div class="reason-tag">DIAGNOSIS</div>
            <div class="reason-text" id="spoilageWhy">‚Äî</div>
          </div>
          <p id="spoilageText" style="display:none"></p>
        </div>

        <!-- Preservation -->
        <div class="panel" id="preservationCard">
          <div class="panel-head">
            <div class="panel-title"><span class="dot dot-green"></span><span id="t-preservation">PRESERVATION ACTIONS</span></div>
            <button class="voice-btn" onclick="speakSection('preservationText')">‚ñ∂</button>
          </div>
          <div class="pres-list" id="preservationBody"></div>
          <p id="preservationText" style="display:none"></p>
        </div>

      </div><!-- /resultsSection -->
    </div><!-- /tab-home -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 2: LIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-pane" id="tab-live">
      <div class="ticker-strip">
        <div class="ticker-track" id="tickerTrack"></div>
      </div>
      <div class="live-statusbar">
        <div class="live-pip"></div>
        <span class="live-label" id="liveStatus">LIVE ¬∑ REFRESHING</span>
        <div class="cdbar"><div class="cdbar-fill" id="cdFill" style="width:100%"></div></div>
        <span class="cd-num" id="cdNum">30s</span>
      </div>
      <div class="filter-strip">
        <div class="sel-wrap" style="flex:1">
          <select class="field" id="liveCropFilter" onchange="filterLive()" style="padding:9px 32px 9px 12px;font-size:12px;border-radius:8px">
            <option value="">All Crops</option>
          </select>
        </div>
        <div class="sel-wrap" style="flex:1">
          <select class="field" id="liveStateFilter" onchange="filterLive()" style="padding:9px 32px 9px 12px;font-size:12px;border-radius:8px">
            <option value="">All States</option>
          </select>
        </div>
        <button class="export-btn" onclick="exportCSV()">‚Üì CSV</button>
      </div>
      <div class="live-list">
        <div class="live-col-head">
          <span onclick="sortBy('name')">COMMODITY ‚áÖ</span>
          <span onclick="sortBy('price')" style="text-align:right">‚Çπ/QTL ‚áÖ</span>
          <span onclick="sortBy('change')" style="text-align:right">CHG ‚áÖ</span>
          <span style="text-align:right">H / L</span>
        </div>
        <div id="liveListBody">
          <div class="load-box"><div class="load-spinner"></div><span class="load-txt">LOADING PRICES</span></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 3: TRENDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-pane" id="tab-trends">
      <div class="trend-selectors">
        <div class="sel-group" style="flex:1">
          <span class="sel-label" id="t-selectCommodity">Commodity</span>
          <div class="sel-wrap">
            <select class="field" id="trendCrop" onchange="drawTrend()"></select>
          </div>
        </div>
      </div>
      <div class="range-row">
        <button class="range-chip active" onclick="setRange('1W',this)">1W</button>
        <button class="range-chip" onclick="setRange('1M',this)">1M</button>
        <button class="range-chip" onclick="setRange('3M',this)">3M</button>
        <button class="range-chip" onclick="setRange('1Y',this)">1Y</button>
        <button class="range-chip" onclick="setRange('ALL',this)">ALL</button>
      </div>
      <div class="date-pair">
        <div class="sel-group">
          <span class="sel-label">FROM</span>
          <input type="date" class="field" id="tFrom" onchange="drawTrend()" style="padding:11px 14px">
        </div>
        <div class="sel-group">
          <span class="sel-label">TO</span>
          <input type="date" class="field" id="tTo" onchange="drawTrend()" style="padding:11px 14px">
        </div>
      </div>
      <div class="chart-wrap">
        <div class="panel-title" style="margin-bottom:4px"><span class="dot dot-gold"></span><span id="chartLabel">PRICE HISTORY</span></div>
        <div class="chart-canvas-wrap">
          <canvas id="trendChart"></canvas>
          <div class="chart-watermark">KISAN GURU</div>
        </div>
      </div>
      <div class="stats-trio">
        <div class="stat-card">
          <div class="stat-label">MIN</div>
          <div class="stat-val sv-min" id="sMin">‚Äî</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">AVG</div>
          <div class="stat-val sv-avg" id="sAvg">‚Äî</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">MAX</div>
          <div class="stat-val sv-max" id="sMax">‚Äî</div>
        </div>
      </div>
      <div class="insight-box" id="insightBox">Select a crop and date range to see price insights.</div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 4: WEATHER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-pane" id="tab-weather">
      <div style="display:flex;gap:8px;align-items:flex-end">
        <div class="sel-group" style="flex:1">
          <span class="sel-label">DISTRICT</span>
          <div class="sel-wrap">
            <select class="field" id="wxDistrict" onchange="loadWeather()"></select>
          </div>
        </div>
        <button class="gps-btn" onclick="useGPSWx()" style="margin-bottom:0">üìç</button>
      </div>
      <div id="wxSection">
        <div class="load-box"><div class="load-spinner"></div><span class="load-txt">LOADING FORECAST</span></div>
      </div>
    </div>

  </div><!-- /content -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <nav id="bottom-nav">
    <button class="nav-tab active" onclick="switchTab('home',this)" id="nav-home">
      <div class="nav-icon-wrap">üè†</div>
      <span id="t-tabHome">HOME</span>
    </button>
    <button class="nav-tab" onclick="switchTab('live',this)" id="nav-live">
      <div class="nav-icon-wrap">üìà</div>
      <span id="t-tabLive">LIVE</span>
      <span class="nav-live-pip"></span>
    </button>
    <button class="nav-tab" onclick="switchTab('trends',this)" id="nav-trends">
      <div class="nav-icon-wrap">üìä</div>
      <span id="t-tabTrends">TRENDS</span>
    </button>
    <button class="nav-tab" onclick="switchTab('weather',this)" id="nav-weather">
      <div class="nav-icon-wrap">üå¶Ô∏è</div>
      <span id="t-tabWeather">WEATHER</span>
    </button>
  </nav>
</div>

<div id="toast"></div>

<!-- ================================================================
     JAVASCRIPT
     ================================================================ -->
<script>
'use strict';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONSTANTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CROPS = ['Rice','Wheat','Maize','Jowar','Bajra','Gram','Tur','Moong','Urad','Lentil',
  'Onion','Potato','Tomato','Brinjal','Cabbage','Cauliflower','Okra','Beans','Peas','Chilli',
  'Garlic','Ginger','Turmeric','Cotton','Sugarcane','Groundnut','Soyabean','Sunflower',
  'Mustard','Eggs','Fish'];

const STATES = {
  'Maharashtra':  ['Pune','Nashik','Nagpur','Kolhapur','Aurangabad','Solapur','Amravati','Satara','Sangli','Latur'],
  'Uttar Pradesh':['Lucknow','Agra','Varanasi','Kanpur','Meerut','Allahabad','Bareilly','Gorakhpur','Mathura','Aligarh'],
  'Punjab':       ['Amritsar','Ludhiana','Jalandhar','Patiala','Bathinda','Mohali','Gurdaspur','Firozpur'],
  'Haryana':      ['Ambala','Rohtak','Hisar','Panipat','Karnal','Sonipat','Faridabad','Gurugram','Sirsa'],
  'Madhya Pradesh':['Indore','Bhopal','Gwalior','Jabalpur','Ujjain','Sagar','Dewas','Satna','Ratlam'],
  'Rajasthan':    ['Jaipur','Jodhpur','Kota','Ajmer','Bikaner','Udaipur','Alwar','Bharatpur'],
  'Gujarat':      ['Ahmedabad','Surat','Vadodara','Rajkot','Bhavnagar','Anand','Junagadh','Gandhinagar'],
  'Karnataka':    ['Bangalore','Mysore','Hubli','Bellary','Gulbarga','Mangalore','Tumkur','Bijapur'],
  'Andhra Pradesh':['Hyderabad','Visakhapatnam','Vijayawada','Guntur','Nellore','Kurnool','Warangal'],
  'West Bengal':  ['Kolkata','Howrah','Durgapur','Asansol','Siliguri','Bardhaman','Malda'],
  'Tamil Nadu':   ['Chennai','Coimbatore','Madurai','Tiruchirappalli','Salem','Erode','Tiruppur'],
  'Kerala':       ['Thiruvananthapuram','Kochi','Kozhikode','Thrissur','Palakkad','Kannur'],
  'Bihar':        ['Patna','Gaya','Muzaffarpur','Bhagalpur','Arrah','Begusarai'],
  'Odisha':       ['Bhubaneswar','Cuttack','Sambalpur','Berhampur','Rourkela','Puri']
};

const MANDIS = ['Mumbai APMC','Delhi Azadpur','Chennai Koyambedu','Kolkata Posta',
  'Bangalore Yeshwanthpur','Ahmedabad APMC','Pune APMC','Hyderabad Gaddiannaram',
  'Jaipur Muhana','Lucknow','Nashik APMC','Indore Krishak Mandi','Guntur',
  'Erode','Rajkot','Nagpur Kalamna','Varanasi','Amritsar','Barwala','Namakkal'];

const PRICE_BASE = {
  Rice:2850, Wheat:2400, Maize:1800, Jowar:2970, Bajra:2350, Gram:5300,
  Tur:6000, Moong:7275, Urad:6800, Lentil:6500, Onion:1800, Potato:1200,
  Tomato:2500, Brinjal:1500, Cabbage:800, Cauliflower:1000, Okra:2000,
  Beans:3000, Peas:3500, Chilli:12000, Garlic:6000, Ginger:8000,
  Turmeric:8500, Cotton:6500, Sugarcane:350, Groundnut:5500, Soyabean:4300,
  Sunflower:5800, Mustard:5200, Eggs:520, Fish:8000
};

const SEASONAL = {
  Rice:    [1.0,1.0,1.02,1.05,1.08,1.1,1.08,1.05,0.95,0.9,0.88,0.92],
  Wheat:   [1.1,1.15,0.95,0.9,1.0,1.05,1.08,1.1,1.12,1.15,1.12,1.1],
  Onion:   [1.5,1.2,0.9,0.7,0.6,0.7,0.9,1.1,1.3,1.5,1.7,1.9],
  Tomato:  [1.8,1.2,0.8,0.6,0.8,1.2,1.6,2.0,1.6,1.2,1.0,1.6],
  Potato:  [1.2,1.1,0.9,0.7,0.65,0.8,1.0,1.1,1.3,1.5,1.3,1.2],
  default: [1.0,1.0,1.0,1.0,1.0,1.05,1.08,1.1,1.08,1.05,1.02,1.0]
};

const WX_CONDITIONS = [
  {icon:'‚òÄÔ∏è', label:'Sunny',          temp:[28,35], rain:0,  humid:[40,60]},
  {icon:'‚õÖ', label:'Partly Cloudy',  temp:[25,32], rain:2,  humid:[50,65]},
  {icon:'üå§Ô∏è', label:'Mostly Clear',   temp:[26,33], rain:0,  humid:[45,60]},
  {icon:'üåßÔ∏è', label:'Rainy',          temp:[22,28], rain:15, humid:[75,90]},
  {icon:'‚õàÔ∏è', label:'Thunderstorms',  temp:[20,26], rain:25, humid:[80,95]},
  {icon:'üå¶Ô∏è', label:'Showers',        temp:[23,29], rain:8,  humid:[65,80]},
  {icon:'üå´Ô∏è', label:'Foggy',          temp:[18,24], rain:0,  humid:[85,95]},
  {icon:'üå¨Ô∏è', label:'Windy',          temp:[24,31], rain:0,  humid:[40,55]}
];

const WX_TIPS = {
  'Sunny':          ['Ideal for field drying after harvest','Good window for pesticide application','Water early morning to reduce evaporation'],
  'Rainy':          ['Avoid harvesting ‚Äî mold risk high','Drain field pathways','Do not spray pesticides today'],
  'Partly Cloudy':  ['Good for transplanting seedlings','Light field work recommended','Check soil moisture levels'],
  'Thunderstorms':  ['Stay clear of open fields','Secure stored grain covers','Reschedule market transport'],
  'Foggy':          ['Delay harvest until afternoon','Watch for fungal spread','No spraying ‚Äî droplets spread unevenly'],
  'Mostly Clear':   ['Harvest window is open','Good transport day for market','Ideal for grain drying on tarpaulin'],
  'Showers':        ['Short sprays between showers only','Check bund integrity in fields','Cover produce before transport'],
  'Windy':          ['Good for natural threshing','Secure nets and covers','Pollination may be affected'],
  'default':        ['Monitor crop for pests','Check soil moisture','Plan your harvest schedule']
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// APP STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lang = {};
let currentLang = 'en';
const LANG_FLAGS = {en:'üá¨üáß', hi:'üáÆüá≥', mr:'üáÆüá≥'};
const LANG_NAMES = {en:'EN', hi:'HI', mr:'MR'};

let liveData = [];
let histData = {};
let trendChart = null;
let sortField = 'name', sortAsc = true;
let liveInterval = null, cdInterval = null, cdVal = 30;
let isDark = true;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BOOT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', async () => {
  const detectedLang = detectLang();
  await loadLang(detectedLang);
  populateAll();
  buildHistData();
  buildLiveData();
  renderLive();
  renderTicker();
  loadWeather();
  setDefaultDates();
  setTimeout(drawTrend, 300);
  registerSW();
  console.log('%cüåæ KISAN MARKET GURU ‚Äî Terminal Edition loaded', 'color:#F5A623;font-weight:bold');
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LANGUAGE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function detectLang() {
  const bl = (navigator.language || 'en').toLowerCase();
  if (bl.startsWith('hi')) return 'hi';
  if (bl.startsWith('mr')) return 'mr';
  return 'en';
}

async function loadLang(code) {
  currentLang = code;
  try {
    const r = await fetch(`langs/${code}.json`);
    lang = await r.json();
  } catch(e) {
    lang = { crops: {}, home: { analyzeBtn:'ANALYZE FIELD', harvestWindow:'HARVEST WINDOW', bestMarkets:'BEST MARKETS', spoilageRisk:'SPOILAGE RISK', preservation:'PRESERVATION', why:'ANALYSIS', voicePlay:'PLAY', selectCrop:'Crop', selectState:'State', selectDistrict:'District', farmSize:'Farm Size' }, tabs: {home:'HOME', live:'LIVE', trends:'TRENDS', weather:'WEATHER'} };
  }
  applyLang();
  document.getElementById('langFlag').textContent = LANG_FLAGS[code];
  document.getElementById('langCode').textContent = LANG_NAMES[code];
}

function applyLang() {
  const h = lang.home || {};
  const t = lang.tabs || {};
  setText('t-inputTitle', 'CROP SELECTOR');
  setText('t-selectCrop', h.selectCrop || 'Crop');
  setText('t-selectState', h.selectState || 'State');
  setText('t-selectDistrict', h.selectDistrict || 'District');
  setText('t-farmSize', h.farmSize || 'Farm Size (Acres) ‚Äî Optional');
  setText('t-analyzeBtn', (h.analyzeBtn || 'ANALYZE FIELD').toUpperCase());
  setText('t-harvestWindow', (h.harvestWindow || 'HARVEST WINDOW').toUpperCase());
  setText('t-bestMarkets', (h.bestMarkets || 'BEST MARKETS').toUpperCase());
  setText('t-spoilageRisk', (h.spoilageRisk || 'SPOILAGE RISK').toUpperCase());
  setText('t-preservation', (h.preservation || 'PRESERVATION').toUpperCase());
  setText('t-why', (h.why || 'ANALYSIS').toUpperCase());
  setText('t-voicePlay', (h.voicePlay || 'PLAY').toUpperCase());
  setText('t-tabHome', (t.home || 'HOME').toUpperCase());
  setText('t-tabLive', (t.live || 'LIVE').toUpperCase());
  setText('t-tabTrends', (t.trends || 'TRENDS').toUpperCase());
  setText('t-tabWeather', (t.weather || 'WEATHER').toUpperCase());
  populateCrops('cropSelect');
  populateCrops('trendCrop');
  populateCrops('liveCropFilter', true);
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el && val) el.textContent = val;
}

function cycleLang() {
  const langs = ['en','hi','mr'];
  const next = langs[(langs.indexOf(currentLang) + 1) % 3];
  loadLang(next);
  toast(`üåê ${LANG_NAMES[next]}`);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// POPULATE DROPDOWNS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateAll() {
  populateCrops('cropSelect');
  populateCrops('trendCrop');
  populateCrops('liveCropFilter', true);

  const stateEl = document.getElementById('stateSelect');
  Object.keys(STATES).forEach(s => {
    stateEl.appendChild(new Option(s, s));
  });
  stateEl.addEventListener('change', populateDistricts);
  populateDistricts();

  const lsf = document.getElementById('liveStateFilter');
  Object.keys(STATES).forEach(s => lsf.appendChild(new Option(s, s)));

  const wxd = document.getElementById('wxDistrict');
  Object.values(STATES).flat().forEach(d => wxd.appendChild(new Option(d, d)));
}

function populateCrops(id, addAll = false) {
  const el = document.getElementById(id);
  if (!el) return;
  const prev = el.value;
  el.innerHTML = '';
  if (addAll) el.appendChild(new Option('All Crops', ''));
  CROPS.forEach(c => {
    const name = (lang.crops && lang.crops[c]) ? `${lang.crops[c]} ¬∑ ${c}` : c;
    el.appendChild(new Option(name, c));
  });
  if (prev) el.value = prev;
}

function populateDistricts() {
  const state = document.getElementById('stateSelect').value;
  const el = document.getElementById('districtSelect');
  el.innerHTML = '';
  (STATES[state] || []).forEach(d => el.appendChild(new Option(d, d)));
}

function setDefaultDates() {
  const now = new Date();
  const to = fmt(now);
  now.setDate(now.getDate() - 7);
  const from = fmt(now);
  const fe = document.getElementById('tFrom');
  const te = document.getElementById('tTo');
  if (fe) fe.value = from;
  if (te) te.value = to;
}

function fmt(d) { return d.toISOString().split('T')[0]; }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB NAVIGATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(id, btn) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('active');
  document.getElementById('content').scrollTo(0, 0);
  if (id === 'live') startLiveLoop();
  if (id === 'trends') setTimeout(drawTrend, 150);
  if (id === 'weather') loadWeather();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ñà‚ñà TAB 1 ‚Äî AI ANALYSIS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function analyzeNow() {
  const crop   = document.getElementById('cropSelect').value;
  const state  = document.getElementById('stateSelect').value;
  const dist   = document.getElementById('districtSelect').value;
  const acres  = parseFloat(document.getElementById('farmSizeInput').value) || 3;

  if (!crop || !state) { toast('‚ö† Select crop and state'); return; }

  const btn = document.getElementById('analyzeBtn');
  btn.innerHTML = '<div style="width:22px;height:22px;border:3px solid rgba(0,0,0,0.3);border-top-color:#000;border-radius:50%;animation:spin 0.7s linear infinite;margin:0 auto"></div>';
  btn.disabled = true;

  setTimeout(() => {
    const a = runAnalysis(crop, state, dist, acres);
    renderResults(a, crop);
    const rs = document.getElementById('resultsSection');
    rs.style.display = 'flex';
    rs.style.flexDirection = 'column';
    rs.style.gap = '14px';
    btn.innerHTML = `<span class="btn-icon">‚ö°</span><span id="t-analyzeBtn">${(lang.home?.analyzeBtn || 'ANALYZE FIELD').toUpperCase()}</span>`;
    btn.disabled = false;
    setTimeout(() => rs.scrollIntoView({behavior:'smooth', block:'start'}), 100);
    launchConfetti();
  }, 1000);
}

function runAnalysis(crop, state, dist, acres) {
  const month = new Date().getMonth();
  const base = PRICE_BASE[crop] || 2000;
  const seasonal = (SEASONAL[crop] || SEASONAL.default)[month];
  const currentPrice = Math.round(base * seasonal * (0.95 + Math.random() * 0.1));

  const humidity = Math.round(50 + Math.random() * 40);
  const temp     = Math.round(24 + Math.random() * 16);
  const rain     = Math.round(Math.random() * 22);

  const weatherScore = Math.max(20, Math.min(100, 100 - rain * 2.5 - (humidity > 80 ? 15 : 0)));
  const soilScore    = Math.max(30, Math.min(100, 105 - humidity * 0.35));
  const priceScore   = seasonal > 1.05 ? 88 : seasonal > 0.95 ? 65 : 42;

  const score = Math.round(weatherScore * 0.4 + soilScore * 0.3 + priceScore * 0.3);
  const days  = score > 80 ? '2-4' : score > 65 ? '5-7' : score > 50 ? '8-12' : '15+';

  const stateMandis = {
    'Maharashtra':  ['Pune APMC','Nashik APMC','Mumbai APMC','Nagpur Kalamna'],
    'Uttar Pradesh':['Lucknow','Agra','Varanasi','Kanpur'],
    'Punjab':       ['Amritsar','Ludhiana','Jalandhar','Patiala'],
    'default':       MANDIS.slice(0, 4)
  };
  const top4 = (stateMandis[state] || stateMandis.default).slice(0, 4);
  const markets = top4.map((m, i) => {
    const p = Math.round(currentPrice * (1 - i * 0.04) * (0.97 + Math.random() * 0.06));
    const up = Math.random() > 0.38;
    return { mandi: m, price: p, dist: [22, 48, 74, 103][i], up, why: up ? 'High demand' : 'Good road' };
  }).sort((a,b) => b.price - a.price);

  const transit = dist.includes('Pune') || dist.includes('Delhi') || dist.includes('Mumbai') ? 1 : 2;
  const spoilage = Math.min(99, Math.round(humidity * 0.4 + (temp / 44 * 100) * 0.3 + (transit / 5 * 100) * 0.3));

  const preservations = [
    { icon:'üõ°Ô∏è', action: crop === 'Onion' || crop === 'Potato' ? 'Ventilated Curing' : 'Hermetic Bag Storage', cost: 800,  eff: 92, why: 'Prevents moisture & mold buildup' },
    { icon:'‚ö°', action: 'Immediate Grading & Sorting',                                                            cost: 200,  eff: 78, why: 'Quality premium = better price' },
    { icon:'‚ùÑÔ∏è', action: humidity > 72 ? 'Rental Cold Storage (< 15¬∞C)' : 'Sun-dry on tarpaulin 2h',             cost: humidity > 72 ? 1400 : 50, eff: 85, why: `Humidity ${humidity}% ‚Üí reduce to < 60%` },
    { icon:'üì¶', action: 'Transport in early morning (< 8AM)',                                                     cost: 0,    eff: 70, why: 'Lower temp reduces spoilage in transit' },
  ];

  return { crop, state, dist, acres, score, days, currentPrice, humidity, temp, rain, transit, spoilage, markets, preservations, weatherScore: Math.round(weatherScore), soilScore: Math.round(soilScore), priceScore: Math.round(priceScore), seasonal };
}

function renderResults(a, crop) {
  // Ring animation
  const offset = 251 - (251 * a.score / 100);
  const ring = document.getElementById('ringFill');
  ring.className = 'ring-fill ' + (a.score > 74 ? 'emerald' : a.score > 49 ? '' : 'red-ring');
  setTimeout(() => ring.style.strokeDashoffset = offset, 100);
  document.getElementById('harvestScore').textContent = a.score;

  document.getElementById('harvestDays').textContent = a.days;

  const statusEl = document.getElementById('harvestStatus');
  if (a.score > 74) { statusEl.textContent = '‚ú¶ HARVEST NOW'; statusEl.className = 'harvest-status status-go'; }
  else if (a.score > 49) { statusEl.textContent = '‚óé HARVEST SOON'; statusEl.className = 'harvest-status status-wait'; }
  else { statusEl.textContent = '‚óà WAIT & MONITOR'; statusEl.className = 'harvest-status status-hold'; }

  document.getElementById('fWeather').style.width = a.weatherScore + '%';
  document.getElementById('fWeatherV').textContent = a.weatherScore;
  document.getElementById('fSoil').style.width = a.soilScore + '%';
  document.getElementById('fSoilV').textContent = a.soilScore;
  document.getElementById('fPrice').style.width = a.priceScore + '%';
  document.getElementById('fPriceV').textContent = a.priceScore;

  const cropN = (lang.crops && lang.crops[crop]) ? lang.crops[crop] : crop;
  const why = `Rain ${a.rain}mm ${a.rain < 6 ? '(low ‚Äî ideal)' : '(moderate ‚Äî caution)'}  ¬∑  Humidity ${a.humidity}% ${a.humidity > 78 ? '(HIGH)' : '(OK)'}  ¬∑  Price trend ${a.seasonal > 1.05 ? '‚Üë RISING +15%' : a.seasonal > 0.95 ? '‚Üí STABLE' : '‚Üì SOFTENING'}`;
  document.getElementById('harvestWhy').textContent = why;
  document.getElementById('harvestText').textContent = `${cropN} harvest score ${a.score}/100. Harvest in ${a.days} days. ${why}.`;

  // Markets
  const mb = document.getElementById('marketsBody');
  mb.innerHTML = '';
  let mText = `Top markets for ${cropN}: `;
  a.markets.forEach((m, i) => {
    const rnClass = ['rn1','rn2','rn3','rn-x'][i] || 'rn-x';
    const tr = document.createElement('tr');
    if (i === 0) tr.className = 'top-row';
    tr.innerHTML = `
      <td><div class="rank-num ${rnClass}">${i+1}</div></td>
      <td><span class="mandi-name">${m.mandi}</span><span class="mandi-state">${a.state}</span></td>
      <td><span class="price-mono">‚Çπ${m.price.toLocaleString('en-IN')}</span></td>
      <td><span class="dist-mono">${m.dist}km</span></td>
      <td><span class="${m.up ? 'trend-up':'trend-dn'}">${m.up ? '‚Üë BUY' : '‚Üì FAIR'}</span></td>`;
    mb.appendChild(tr);
    mText += `${m.mandi} ‚Çπ${m.price} per quintal ${m.dist}km. `;
  });
  document.getElementById('marketsText').textContent = mText;

  // Spoilage
  const sp = a.spoilage;
  const rp = document.getElementById('riskPct');
  rp.textContent = sp + '%';
  rp.className = 'risk-pct ' + (sp < 25 ? 'risk-low' : sp < 55 ? 'risk-med' : 'risk-high');
  document.getElementById('riskWord').textContent = sp < 25 ? '‚úì LOW' : sp < 55 ? '‚ö† MEDIUM' : '‚úó HIGH';
  document.getElementById('rfHumid').textContent = a.humidity + '%';
  document.getElementById('rfTemp').textContent = a.temp + '¬∞C';
  document.getElementById('rfTransit').textContent = a.transit + ' day' + (a.transit > 1 ? 's' : '');
  document.getElementById('rfHumidBar').style.width = a.humidity + '%';
  document.getElementById('rfHumidBar').className = 'rf-fill ' + (a.humidity > 75 ? 'fill-gold' : 'fill-green');
  document.getElementById('rfTempBar').style.width = (a.temp / 44 * 100) + '%';
  document.getElementById('rfTransitBar').style.width = (a.transit / 5 * 100) + '%';
  const sWhy = `${a.humidity}% humidity ${a.humidity>75?'(HIGH ‚Äî mold risk)':'(acceptable)'}  +  ${a.temp}¬∞C temp  +  ${a.transit}-day transit = ${sp < 25 ? 'LOW' : sp < 55 ? 'MEDIUM' : 'HIGH'} spoilage risk`;
  document.getElementById('spoilageWhy').textContent = sWhy;
  document.getElementById('spoilageText').textContent = `Spoilage risk for ${cropN} is ${sp}%. ${sWhy}`;

  // Preservation
  const pb = document.getElementById('preservationBody');
  pb.innerHTML = '';
  let pText = `Preservation actions for ${cropN}: `;
  a.preservations.forEach((p, i) => {
    const effClass = p.eff >= 85 ? 'eff-high' : p.eff >= 70 ? 'eff-mid' : 'eff-low';
    const div = document.createElement('div');
    div.className = 'pres-item';
    div.innerHTML = `
      <div class="pres-rank-box">${p.icon}</div>
      <div class="pres-info">
        <div class="pres-action">${p.action}</div>
        <div class="pres-why">${p.why}</div>
      </div>
      <div class="pres-cost">${p.cost > 0 ? '‚Çπ'+p.cost : 'FREE'}</div>
      <div class="eff-arc ${effClass}">${p.eff}%</div>`;
    pb.appendChild(div);
    pText += `${p.action} (${p.cost > 0 ? '‚Çπ'+p.cost : 'free'}, ${p.eff}% effective). `;
  });
  document.getElementById('preservationText').textContent = pText;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ñà‚ñà TAB 2 ‚Äî LIVE PRICES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildLiveData() {
  const month = new Date().getMonth();
  liveData = CROPS.map(crop => {
    const base = PRICE_BASE[crop] || 2000;
    const sf = (SEASONAL[crop] || SEASONAL.default)[month];
    const price = Math.round(base * sf * (0.95 + Math.random() * 0.1));
    const chg = (Math.random() * 6 - 3);
    const prev = Math.round(price / (1 + chg / 100));
    const high = Math.round(price * (1 + Math.random() * 0.05));
    const low  = Math.round(price * (1 - Math.random() * 0.05));
    const mandi = MANDIS[Math.floor(Math.random() * MANDIS.length)];
    const state = Object.keys(STATES)[Math.floor(Math.random() * Object.keys(STATES).length)];
    return { name: crop, price, prev, chg, high, low, mandi, state };
  });
}

function updateLiveData() {
  liveData = liveData.map(d => {
    const delta = (Math.random() * 1.4 - 0.7);
    const newPrice = Math.round(d.price * (1 + delta / 100));
    return {
      ...d,
      prev: d.price,
      price: newPrice,
      chg: (newPrice - d.prev) / d.prev * 100,
      high: Math.max(d.high, newPrice),
      low:  Math.min(d.low, newPrice)
    };
  });
}

function renderLive() {
  const cropF  = document.getElementById('liveCropFilter')?.value || '';
  const stateF = document.getElementById('liveStateFilter')?.value || '';

  let rows = liveData.filter(d =>
    (!cropF || d.name === cropF) && (!stateF || d.state === stateF)
  );

  rows.sort((a, b) => {
    const av = sortField === 'price' ? a.price : sortField === 'change' ? a.chg : a.name;
    const bv = sortField === 'price' ? b.price : sortField === 'change' ? b.chg : b.name;
    return sortAsc ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
  });

  const container = document.getElementById('liveListBody');
  if (!container) return;

  if (rows.length === 0) {
    container.innerHTML = '<div class="empty-box"><div class="empty-glyph">üîç</div><div class="empty-h">No Results</div><div class="empty-p">Adjust your filters</div></div>';
    return;
  }

  container.innerHTML = '';
  rows.forEach(d => {
    const up = d.chg >= 0;
    const sign = up ? '+' : '';
    const cropN = (lang.crops && lang.crops[d.name]) ? lang.crops[d.name] : d.name;
    const row = document.createElement('div');
    row.className = 'price-row';
    row.dataset.crop = d.name;
    row.innerHTML = `
      <div>
        <div class="pr-name">${cropN}</div>
        <div class="pr-local">${d.mandi}</div>
      </div>
      <div class="pr-price">‚Çπ${d.price.toLocaleString('en-IN')}</div>
      <div class="pr-chg ${up ? 'pr-up' : 'pr-dn'}">${up?'‚Üë':'‚Üì'} ${sign}${d.chg.toFixed(1)}%</div>
      <div class="pr-hl">‚Çπ${d.high.toLocaleString('en-IN')}<br>‚Çπ${d.low.toLocaleString('en-IN')}</div>`;
    container.appendChild(row);
  });
}

function renderTicker() {
  const items = liveData.slice(0, 16);
  const html = [...items, ...items].map(d => {
    const up = d.chg >= 0;
    const name = (lang.crops && lang.crops[d.name]) ? lang.crops[d.name] : d.name;
    return `<span class="ticker-chip"><span class="tc-name">${name}</span><span class="tc-price">‚Çπ${d.price.toLocaleString('en-IN')}</span><span class="${up ? 'tc-up' : 'tc-dn'}">${up?'+':''}${d.chg.toFixed(1)}%</span></span>`;
  }).join('');
  const el = document.getElementById('tickerTrack');
  if (el) el.innerHTML = html;
}

function startLiveLoop() {
  if (liveInterval) return;
  cdVal = 30;
  liveInterval = setInterval(() => {
    updateLiveData();
    renderLive();
    renderTicker();
    cdVal = 30;
    const t = new Date().toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    setText('liveStatus', `LIVE ¬∑ UPDATED ${t}`);
  }, 30000);
  cdInterval = setInterval(() => {
    cdVal = Math.max(0, cdVal - 1);
    const fill = document.getElementById('cdFill');
    const num  = document.getElementById('cdNum');
    if (fill) fill.style.width = (cdVal / 30 * 100) + '%';
    if (num)  num.textContent = cdVal + 's';
  }, 1000);
}

function filterLive() { renderLive(); }

function sortBy(field) {
  if (sortField === field) sortAsc = !sortAsc;
  else { sortField = field; sortAsc = true; }
  renderLive();
}

function exportCSV() {
  const hdrs = ['Commodity','Price(‚Çπ/Qtl)','Change%','High','Low','Top Mandi','State'];
  const rows = liveData.map(d => [d.name, d.price, d.chg.toFixed(2), d.high, d.low, d.mandi, d.state]);
  const csv = [hdrs, ...rows].map(r => r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = `kisan-prices-${fmt(new Date())}.csv`;
  a.click();
  toast('‚úì CSV EXPORTED');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ñà‚ñà TAB 3 ‚Äî TRENDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildHistData() {
  const now = new Date();
  CROPS.forEach(crop => {
    const base = PRICE_BASE[crop] || 2000;
    const sf = SEASONAL[crop] || SEASONAL.default;
    histData[crop] = [];
    for (let d = 730; d >= 0; d--) {
      const dt = new Date(now);
      dt.setDate(dt.getDate() - d);
      const m = dt.getMonth();
      histData[crop].push({
        date: fmt(dt),
        price: Math.round(base * sf[m] * (0.9 + Math.random() * 0.2))
      });
    }
  });
}

function setRange(r, btn) {
  document.querySelectorAll('.range-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const now = new Date();
  const to = fmt(now);
  let from;
  const d = new Date(now);
  if      (r === '1W')  { d.setDate(d.getDate()-7);       from = fmt(d); }
  else if (r === '1M')  { d.setMonth(d.getMonth()-1);     from = fmt(d); }
  else if (r === '3M')  { d.setMonth(d.getMonth()-3);     from = fmt(d); }
  else if (r === '1Y')  { d.setFullYear(d.getFullYear()-1); from = fmt(d); }
  else                   { from = '2023-01-01'; }
  document.getElementById('tFrom').value = from;
  document.getElementById('tTo').value = to;
  drawTrend();
}

function drawTrend() {
  const crop = document.getElementById('trendCrop').value;
  const from = document.getElementById('tFrom').value;
  const to   = document.getElementById('tTo').value;
  if (!crop || !histData[crop]) return;

  const data = histData[crop].filter(d => d.date >= from && d.date <= to);
  if (!data.length) return;

  const labels = data.map(d => { const dt=new Date(d.date); return `${dt.getDate()}/${dt.getMonth()+1}`; });
  const prices = data.map(d => d.price);

  const mn = Math.min(...prices), mx = Math.max(...prices), av = Math.round(prices.reduce((a,b)=>a+b,0)/prices.length);
  document.getElementById('sMin').textContent = '‚Çπ'+mn.toLocaleString('en-IN');
  document.getElementById('sAvg').textContent = '‚Çπ'+av.toLocaleString('en-IN');
  document.getElementById('sMax').textContent = '‚Çπ'+mx.toLocaleString('en-IN');

  const trend = prices[prices.length-1] > prices[0] ? 'rising' : 'falling';
  const chgPct = ((prices[prices.length-1] - prices[0]) / prices[0] * 100).toFixed(1);
  const cropN = (lang.crops && lang.crops[crop]) ? lang.crops[crop] : crop;
  document.getElementById('insightBox').textContent =
    `‚óà ${cropN} prices are ${trend} by ${Math.abs(chgPct)}% over this period. ` +
    (trend === 'rising' ? 'Selling window is opening ‚Äî act soon.' : 'Consider holding stock for price recovery.');
  document.getElementById('chartLabel').textContent = `${cropN.toUpperCase()} ¬∑ ‚Çπ/QTL`;

  const ctx = document.getElementById('trendChart').getContext('2d');
  if (trendChart) trendChart.destroy();

  const step = Math.max(1, Math.floor(data.length / 70));
  const sl = labels.filter((_,i) => i%step===0);
  const sp = prices.filter((_,i) => i%step===0);

  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sl,
      datasets: [{
        label: '‚Çπ/Qtl',
        data: sp,
        borderColor: '#F5A623',
        backgroundColor: (ctx) => {
          const g = ctx.chart.ctx.createLinearGradient(0,0,0,ctx.chart.height);
          g.addColorStop(0, 'rgba(245,166,35,0.25)');
          g.addColorStop(1, 'rgba(245,166,35,0.01)');
          return g;
        },
        borderWidth: 2,
        pointRadius: sp.length < 25 ? 3 : 0,
        pointHoverRadius: 5,
        pointBorderColor: '#F5A623',
        pointBackgroundColor: '#0A0A0A',
        fill: true,
        tension: 0.35
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(20,20,20,0.95)',
          titleColor: '#8A8070',
          bodyColor: '#F5A623',
          borderColor: 'rgba(245,166,35,0.3)',
          borderWidth: 1,
          titleFont: { family:'Space Mono', size:10 },
          bodyFont: { family:'Space Mono', size:13 },
          callbacks: { label: c => `‚Çπ${c.parsed.y.toLocaleString('en-IN')} per Quintal` }
        }
      },
      scales: {
        x: {
          ticks: { color:'#5A5248', font:{family:'Space Mono', size:9}, maxTicksLimit:7, maxRotation:0 },
          grid:  { color:'rgba(255,255,255,0.04)' },
          border:{ color:'rgba(255,255,255,0.06)' }
        },
        y: {
          ticks: { color:'#5A5248', font:{family:'Space Mono', size:9}, callback: v => '‚Çπ'+v.toLocaleString('en-IN') },
          grid:  { color:'rgba(255,255,255,0.04)' },
          border:{ color:'rgba(255,255,255,0.06)' }
        }
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ñà‚ñà TAB 4 ‚Äî WEATHER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadWeather() {
  const dist = document.getElementById('wxDistrict')?.value || 'Pune';
  document.getElementById('wxSection').innerHTML = '<div class="load-box"><div class="load-spinner"></div><span class="load-txt">LOADING FORECAST</span></div>';
  setTimeout(() => renderWeather(genForecast(), dist), 700);
}

function genForecast() {
  const month = new Date().getMonth();
  const isMonsoon = month >= 5 && month <= 9;
  const isWinter  = month >= 10 || month <= 1;
  return Array.from({length:7}, (_, i) => {
    const date = new Date(); date.setDate(date.getDate() + i);
    let pool;
    if (isMonsoon)      pool = [WX_CONDITIONS[3],WX_CONDITIONS[4],WX_CONDITIONS[5],WX_CONDITIONS[1]];
    else if (isWinter)  pool = [WX_CONDITIONS[0],WX_CONDITIONS[2],WX_CONDITIONS[6],WX_CONDITIONS[1]];
    else                pool = [WX_CONDITIONS[0],WX_CONDITIONS[1],WX_CONDITIONS[2],WX_CONDITIONS[5]];
    const c = pool[Math.floor(Math.random() * pool.length)];
    const adj = isWinter ? -8 : 0;
    return {
      date, c,
      tMin: c.temp[0] + adj + Math.round(Math.random()*3 - 1),
      tMax: c.temp[1] + adj + Math.round(Math.random()*3 - 1),
      rain: c.rain + Math.round(Math.random()*5),
      humid: c.humid[0] + Math.round(Math.random()*(c.humid[1]-c.humid[0])),
      wind: 8 + Math.round(Math.random()*22),
      tip: (WX_TIPS[c.label]||WX_TIPS.default)[Math.floor(Math.random()*3)]
    };
  });
}

function renderWeather(fc, dist) {
  const DAYS  = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const MONTHS= ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const today = fc[0];

  let html = `
  <div class="today-weather">
    <div class="today-icon">${today.c.icon}</div>
    <div class="today-info">
      <div class="today-loc">${dist.toUpperCase()}</div>
      <div class="today-cond">${today.c.label}</div>
      <div class="today-temp">${today.tMin}¬∞‚Äì${today.tMax}¬∞C</div>
      <div class="today-sub">üíß ${today.humid}%  ¬∑  üåßÔ∏è ${today.rain}mm  ¬∑  üí® ${today.wind} km/h</div>
    </div>
  </div>
  <div class="forecast-scroll">`;

  fc.forEach((day, i) => {
    const d = day.date;
    const label = i === 0 ? 'TODAY' : i === 1 ? 'TMR' : DAYS[d.getDay()].toUpperCase();
    html += `<div class="fc-day ${i===0?'fc-today':''}">
      <div class="fc-dayname">${label}<br>${d.getDate()} ${MONTHS[d.getMonth()]}</div>
      <div class="fc-icon">${day.c.icon}</div>
      <div class="fc-temp">${day.tMin}¬∞-${day.tMax}¬∞</div>
      <div class="fc-rain">üíß${day.rain}mm</div>
      <div class="fc-humid">${day.humid}%</div>
    </div>`;
  });
  html += '</div>';

  html += '<div class="panel" style="margin-top:0"><div class="panel-head"><div class="panel-title"><span class="dot dot-gold"></span>FARMING TIPS</div></div><div class="tips-list" style="padding:10px 14px 14px">';
  fc.slice(0, 4).forEach((day, i) => {
    const label = i===0?'TODAY':i===1?'TOMORROW':DAYS[day.date.getDay()].toUpperCase();
    html += `<div class="tip-item">
      <div class="tip-day-badge">${label}</div>
      <div class="tip-text"><span class="tip-icon">${day.c.icon}</span>${day.tip}</div>
    </div>`;
  });
  html += '</div></div>';

  document.getElementById('wxSection').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GPS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function useGPS() {
  if (!navigator.geolocation) { toast('‚úó GPS unavailable'); return; }
  toast('‚óé DETECTING LOCATION‚Ä¶');
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude: lat, longitude: lng } = pos.coords;
    let state = 'Maharashtra';
    if      (lat > 29 && lng > 75 && lng < 78) state = 'Haryana';
    else if (lat > 30 && lng > 73 && lng < 76) state = 'Punjab';
    else if (lat > 25 && lat < 30 && lng > 78) state = 'Uttar Pradesh';
    else if (lat > 22 && lat < 26 && lng > 72 && lng < 75) state = 'Rajasthan';
    else if (lat > 21 && lat < 26 && lng > 76 && lng < 82) state = 'Madhya Pradesh';
    const el = document.getElementById('stateSelect');
    if (el) { el.value = state; populateDistricts(); }
    toast(`‚úì ${state} DETECTED`);
  }, () => toast('‚úó LOCATION DENIED'));
}

function useGPSWx() {
  toast('‚óé LOCATING‚Ä¶');
  if (!navigator.geolocation) { toast('‚úó GPS unavailable'); return; }
  navigator.geolocation.getCurrentPosition(() => { toast('‚úì LOCATION FOUND'); loadWeather(); }, () => toast('‚úó LOCATION DENIED'));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// VOICE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function speakSection(textId) {
  if (!window.speechSynthesis) { toast('‚úó VOICE NOT SUPPORTED'); return; }
  const text = document.getElementById(textId)?.textContent;
  if (!text) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = {en:'en-IN', hi:'hi-IN', mr:'mr-IN'}[currentLang] || 'en-IN';
  u.rate = 0.88;
  const v = speechSynthesis.getVoices().find(v => v.lang.startsWith(u.lang.split('-')[0]));
  if (v) u.voice = v;
  speechSynthesis.speak(u);
  toast('‚ñ∂ PLAYING AUDIO');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// THEME
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTheme() {
  isDark = !isDark;
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('themeBtn').textContent = isDark ? '‚òÄ' : '‚òæ';
  if (!isDark) applyLightTheme();
  else applyDarkTheme();
  setTimeout(drawTrend, 100);
}

function applyLightTheme() {
  const r = document.documentElement.style;
  r.setProperty('--bg',     '#F7F3ED');
  r.setProperty('--bg2',    '#EEEAD4');
  r.setProperty('--bg3',    '#E8E4D8');
  r.setProperty('--surface','rgba(0,0,0,0.03)');
  r.setProperty('--surface2','rgba(0,0,0,0.06)');
  r.setProperty('--border', 'rgba(0,0,0,0.1)');
  r.setProperty('--border-gold','rgba(180,110,0,0.35)');
  r.setProperty('--text',   '#1A1206');
  r.setProperty('--text-dim','#5A4A2A');
  r.setProperty('--text-muted','#A09070');
  r.setProperty('--gold',   '#B8720A');
  r.setProperty('--gold-glow','rgba(184,114,10,0.12)');
}

function applyDarkTheme() {
  const r = document.documentElement.style;
  r.setProperty('--bg',     '#0A0A0A');
  r.setProperty('--bg2',    '#111111');
  r.setProperty('--bg3',    '#181818');
  r.setProperty('--surface','rgba(255,255,255,0.04)');
  r.setProperty('--surface2','rgba(255,255,255,0.07)');
  r.setProperty('--border', 'rgba(255,255,255,0.08)');
  r.setProperty('--border-gold','rgba(245,166,35,0.3)');
  r.setProperty('--text',   '#F0EAD6');
  r.setProperty('--text-dim','#8A8070');
  r.setProperty('--text-muted','#5A5248');
  r.setProperty('--gold',   '#F5A623');
  r.setProperty('--gold-glow','rgba(245,166,35,0.18)');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TOAST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2800);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONFETTI
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function launchConfetti() {
  const cols = ['#F5A623','#00D084','#4DA6FF','#FF4D4D','#C084FC'];
  for (let i = 0; i < 45; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'cpiece';
      el.style.cssText = `left:${Math.random()*100}vw;top:-8px;width:${5+Math.random()*7}px;height:${5+Math.random()*7}px;background:${cols[Math.floor(Math.random()*cols.length)]};animation-duration:${2+Math.random()*2.5}s;animation-delay:${Math.random()*0.4}s`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }, i * 28);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SERVICE WORKER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function registerSW() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('‚úì SW registered'))
      .catch(e => console.log('SW error:', e));
  }
}
</script>
</body>
</html>
